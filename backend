from flask import Flask, request, jsonify, send_from_directory
import speech_recognition as sr
import json
import os

app = Flask(__name__, static_folder='../frontend')

@app.route('/')
def index():
    return send_from_directory('../frontend', 'index.html')

@app.route('/transcribe', methods=['POST'])
def transcribe():
    audio_file = request.files['audio']
    audio_path = "temp.wav"
    audio_file.save(audio_path)

    recognizer = sr.Recognizer()
    with sr.AudioFile(audio_path) as source:
        audio_data = recognizer.record(source)
        try:
            text = recognizer.recognize_google(audio_data, language="fa-IR")
        except sr.UnknownValueError:
            text = "متاسفانه نتوانستم متوجه گفتار شوم."
        except sr.RequestError:
            text = "خطا در اتصال به سرویس گوگل."

    return jsonify({'text': text})

@app.route('/save-correction', methods=['POST'])
def save_correction():
    data = request.json
    corrections_path = "../data/corrections.json"
    corrections = []

    if os.path.exists(corrections_path):
        with open(corrections_path, 'r', encoding='utf-8') as f:
            corrections = json.load(f)

    corrections.append(data)

    with open(corrections_path, 'w', encoding='utf-8') as f:
        json.dump(corrections, f, ensure_ascii=False, indent=2)

    return jsonify({"status": "saved"})

if __name__ == '__main__':
    os.makedirs('../data', exist_ok=True)
    app.run(debug=True)